name: Data Sync Cron Jobs

on:
  # ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å®Ÿè¡Œ
  schedule:
    # people: æ¯æ—¥ 2:00 UTC (æ—¥æœ¬æ™‚é–“ 11:00)
    - cron: '0 2 * * *'
    # visas: æ¯æ—¥ 3:00 UTC (æ—¥æœ¬æ™‚é–“ 12:00)  
    - cron: '0 3 * * *'
  
  # æ‰‹å‹•å®Ÿè¡Œ
  workflow_dispatch:
    inputs:
      sync_type:
        description: 'Sync type to run'
        required: true
        default: 'both'
        type: choice
        options:
          - people
          - visas
          - both

jobs:
  sync-people:
    if: github.event_name == 'schedule' && github.event.schedule == '0 2 * * *' || github.event_name == 'workflow_dispatch' && (github.event.inputs.sync_type == 'people' || github.event.inputs.sync_type == 'both')
    runs-on: ubuntu-latest
    timeout-minutes: 360  # 6æ™‚é–“ã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
    
    steps:
      - name: Sync People Data
        run: |
          echo "ğŸ• Starting people sync at $(date)"
          
          # APIå‘¼ã³å‡ºã—
          response=$(curl -s -w "\n%{http_code}" \
            -X GET \
            "${{ secrets.API_BASE_URL }}/api/cron/sync-by-type?type=people&secret=${{ secrets.CRON_SECRET }}")
          
          # ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã¨ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’åˆ†é›¢
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n -1)
          
          echo "Response status: $http_code"
          echo "Response body: $body"
          
          if [ "$http_code" -eq 200 ]; then
            echo "âœ… People sync completed successfully"
            echo "$body" | jq '.'
          else
            echo "âŒ People sync failed with status $http_code"
            echo "$body"
            exit 1
          fi

  sync-visas:
    if: github.event_name == 'schedule' && github.event.schedule == '0 3 * * *' || github.event_name == 'workflow_dispatch' && (github.event.inputs.sync_type == 'visas' || github.event.inputs.sync_type == 'both')
    runs-on: ubuntu-latest
    timeout-minutes: 360  # 6æ™‚é–“ã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
    
    steps:
      - name: Sync Visas Data
        run: |
          echo "ğŸ• Starting visas sync at $(date)"
          
          # APIå‘¼ã³å‡ºã—
          response=$(curl -s -w "\n%{http_code}" \
            -X GET \
            "${{ secrets.API_BASE_URL }}/api/cron/sync-by-type?type=visas&secret=${{ secrets.CRON_SECRET }}")
          
          # ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã¨ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’åˆ†é›¢
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n -1)
          
          echo "Response status: $http_code"
          echo "Response body: $body"
          
          if [ "$http_code" -eq 200 ]; then
            echo "âœ… Visas sync completed successfully"
            echo "$body" | jq '.'
          else
            echo "âŒ Visas sync failed with status $http_code"
            echo "$body"
            exit 1
          fi
